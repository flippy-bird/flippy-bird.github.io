---
title: 数据对齐问题
date: 2021-11-17 22:59:59
tags: "bug"
categories: 
    - OpenGL
description: 记录一个使用OpenGL渲染时纹理未对齐的问题
cover: /covers/4.webp
---


## 数据对齐问题

<!-- more -->

### 现象

我在使用OpenGL加载一个图片数据时,其中数据的宽高不是2的n次方，导致了解析的出来的图片出现了问题，如下图：

 <img src="https://raw.githubusercontent.com/nashpan/image-hosting/main/markdown_image/opengl_image_error.png" alt="opengl_image_error" style="zoom: 50%;" />

我加载纹理数据的代码如下：

![opengl_image_error1](https://raw.githubusercontent.com/nashpan/image-hosting/main/markdown_image/opengl_image_error1.png)

### Solution

> 像数据在内存中很少以紧密包装的形式存在，在很多硬件平台上，出于性能考虑，图像的每一行应该都从某个特定对齐地址开始。在默认情况下，OpenGL采用4个字节的对齐方式。例如，有一张RGB图像，包含3个分量，每个分量占1个字节，如果图像宽度为199像素，那么每一行需要的字节数为597字节。但是如果硬件的体系结构是以4字节排列，那么图像的每一行末尾都会填充额外的3个空字节，从而使得每一行的内存地址偏移量为4的整数倍。尽管这样表面上看起来是浪费了内存空间，但是这种排列能够让大多数CPU更高效的获取数据块。另外许多未经压缩的图形格式也遵循这种惯例，如Windows中的.BMP文件。Targa(.TGA)是以1字节排列的。
>
> 在向OpenGL提交图像数据或从OpenGL中获取图像数据时，OpenGL需要知道对数据以何种方式包装和解包装操作。通过函数`void glPixelStorei (GLenum pname, GLint param)`，`glPixelStoref (GLenum pname, GLfloat param)`可以改变或者恢复像素的存储方式。例如需要改成紧密包装方式(即像素行的对齐方式，可选1.2.4.8)调用函数`glPixelStorei(GL_UNPACK_ALIGNMENT, 1)`。其参数都是以GL_UNPACK_和GL_PACK_为前缀方式成对出现，前着表示从内存中读取数据(对函数`glReadPixels`产生影响)，后者表示存储数据至内存中(对调用函数`glTexImage2D`等产生影响)。
>
> [OpenGL 数据处理(下)](https://www.jianshu.com/p/513afcb71c97)

解决这个问题的方法是在创建纹理的时候将纹理设置为1字节对齐即可，如下，即可解决问题：

```C++
glPixelStorei(GL_UNPACK_ALIGNMENT, 1)     // 这里的GL_UNPACK_ALIGNMENT是指上传数据
```

当我们要从fbo读取数据的时候，可能也存在这样的问题，同理，我们在读取纹理的时候设置下面的参数即可

```C++
glPixelStorei(GL_PACK_ALIGNMENT, 1)
```

